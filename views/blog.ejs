<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('./partials/head') %>
    <title>Blog</title>
    </head>
    <body>
    <%- include('./partials/nav') %>
    <div class="container mt-4">
      <h1><%= blog.title %></h1>
      <img class="mt-3" src="<%= blog.coverImageUrl || '/images/default.png' %>" width="1000px" />
      <pre class="mt-3" style="font-size: 18px;"><%= blog.body %></pre>
    </div>
    <div class="container mt-5">
      Author:
      <br><br>
      <img src="<%= blog.CreatedBy.profileImageURL %>" width="40px">
      <%= blog.CreatedBy.fullName %>
      <% if(locals.user && (user._id.toString() === blog.CreatedBy._id.toString() || user.role === 'ADMIN')) { %>
        <button class="btn btn-danger float-end" onclick="deleteBlog('<%= blog._id %>')">Delete Blog</button>
      <% } %>
    </div>
    <div class="container mt-3">
      <h3>Comments <%= comments.length %></h3>
      <%if(locals.user){%>
        <form action="/blog/comment/<%= blog._id %>" method="post">
          <div class="mb-3">
            <input type="text" name="content" class="form-control" placeholder="Add a Comment">
          </div>
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      <%}%>
      <div class="mt-3">
      <% comments.forEach(function(comment){ %>
        <div class="card mb-2">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <img src="<%= comment.CreatedBy.profileImageURL %>" width="30px" class="me-2">
                <strong><%= comment.CreatedBy.fullName %></strong>
                <p class="card-text mt-2"><%= comment.content %></p>
              </div>
              <% if(locals.user && (user._id.toString() === comment.CreatedBy._id.toString() || user._id.toString() === blog.CreatedBy._id.toString() || user.role === 'ADMIN')) { %>
                <button class="btn btn-sm btn-danger" onclick="deleteComment('<%= comment._id %>')">Delete</button>
              <% } %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
    </div>
    <%- include('./partials/scripts') %>
    <script>
      function deleteBlog(blogId) {
        if(confirm('Are you sure you want to delete this blog?')) {
          fetch(`/blog/${blogId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
              alert(data.message || data.error);
              if (data.message) window.location.href = '/';
            })
            .catch(err => alert('Error deleting blog'));
        }
      }
      
      function deleteComment(commentId) {
        if(confirm('Are you sure you want to delete this comment?')) {
          fetch(`/blog/comment/${commentId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
              alert(data.message || data.error);
              if (data.message) window.location.reload();
            })
            .catch(err => alert('Error deleting comment'));
        }
      }
    </script>
  </body>
</html>